import {promises as fs} from 'fs';
import {Ora} from 'ora';
import path from 'path';

/**
 * Set up credentials file for Google cloud
 *
 * @param {string|undefined} credentials
 * @param {Ora} spinner
 * @return {Promise<void>}
 */
export async function setupCredentials(spinner: Ora, credentials?: string) {
  if (!credentials) {
    spinner.fail(
      `Please use option -c to specify credentials file or -h for more details`
    );
    return;
  }

  // Look up credentials file for Google Cloud
  let credentialFilePath = `${process.cwd()}/${credentials}`;
  if (path.isAbsolute(credentials)) {
    credentialFilePath = credentials;
  }

  // Check this file is exist or not
  try {
    await fs.access(credentialFilePath);
  } catch (e) {
    spinner.fail(
      `File ${credentialFilePath} doesn't exist. Please try another file.`
    );
    return;
  }
  process.env.GOOGLE_APPLICATION_CREDENTIALS = credentialFilePath;
}
