import admin from 'firebase-admin';
import {promises as fs} from 'fs';
import ora from 'ora';
import {setupCredentials} from '../../helpers/credentials';

admin.initializeApp();

const db = admin.firestore();
db.settings({timestampsInSnapshots: true});

interface Options {
  credentials?: string;
  file?: string;
}

/**
 * Export all items from collection to a file
 *
 * @see https://raw.githubusercontent.com/dalenguyen/firestore-import-export/master/export.js
 * @param {String} collection
 * @param {Options} options
 */
export default async function exportFirestore(
  collection: string,
  options: Options
) {
  const spinner = ora('').start();
  spinner.info(`Exporting Firestore for collection: ${collection}`);

  await setupCredentials(spinner, options.credentials);

  const fileName = options.file || `export_${collection}}`;

  const items = await db.collection(collection).get();
  for (let i = 0; i < items.size; i++) {
    const doc = items.docs[i];
    try {
      await fs.writeFile(`${fileName}.json`, JSON.stringify(doc));
    } catch (e) {
      spinner.fail(`Export document ${doc.id} failed`);
    }
  }
  spinner.succeed(`Congratulations! All items saved to ${fileName}.json`);
}
